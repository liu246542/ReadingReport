% !Tex root = ../main.tex

\chapter{新型数据结构}

在这一章，我们将重点介绍由布隆过滤器衍生出来的几个特殊数据结构，分别是布谷鸟过滤器，异或型过滤器以及不经意的键值存储。
% 从上一章的分类我们知道，对于

\section{布谷鸟过滤器}

从上一章的分类我们可以知道，布谷鸟过滤器是一种 OR 型的过滤器，且 $f(x)$ 为 $x$ 的指纹信息。
布谷鸟过滤器的概念最早是由 Fan 等人~\cite{fan2014cuckoo} 于2014年提出的，其构造方式受到了布谷鸟哈希表（Cuckoo Hash Table）~\cite{pagh2004cuckoo}的启发。
在介绍布谷鸟过滤器之前，我们首先介绍布谷鸟哈希表的构造。

\subsection{布谷鸟哈希表}

布谷鸟哈希表可以看作一个由多个桶（bucket）组成的数组结构。
对于每个元素 $x$ 来说，它在哈希表中对应两个候选位置，分别由两个哈希函数 $h_1(x)$ 和 $h_2(x)$ 决定。
在插入元素 $x$ 时，首先检查 $x$ 对应的两个位置上的桶中是否有多余位置。
如果两个桶都有多余空间，则直接将 $x$ 放入桶中；如果两个桶都已满，则随机在一个候选位置上踢出一个元素并将 $x$ 放入该位置上。踢出的元素则重新插入到它对应的另一个候选位置上。
如图所示，假设每个桶中都只能存储一个元素，当插入元素 $x$ 时，首先计算出它的两个候选位置分别是 $2$ 和 $6$。
因为 $2$ 和 $6$ 两个位置都已满，这里选择踢出位置 $6$ 上的元素 $a$，并将 $x$ 放入其中。
被踢出的 $a$ 则重新插入到它的另一个候选位置，也就是 $4$ 上。
由于位置 $4$ 上已有元素 $c$，则把 $c$ 踢出，将 $a$ 存储在位置 $4$ 中，并将 $c$ 重新插入到它的候选位置 $1$ 上，最终结果如图所示。
这种``踢出-插入''的思路与布谷鸟下蛋时会将蛋放入其他鸟的巢穴，并挤出原本巢中蛋的行为很相似，因此而得名。

\subsection{布谷鸟过滤器的构造}

与布谷鸟哈希表类似，布谷鸟过滤器也是由多个桶组成的数组结构。
不同的是，在布谷鸟过滤器中每个桶中存储的并不是元素本身，而是元素的指纹。
这就导致在将桶中的元素指纹踢出时，无法根据指纹信息确定它的另一个候选位置。
因此布谷鸟过滤器采用了部分密钥布谷鸟哈希（partial-key cuckoo hashing）的技巧来解决该问题。
也就是将元素的两个候选位置与元素的指纹值建立联系，这样就能在只知道元素的指纹值和其中一个位置信息的情况下计算出另一个位置信息。
具体来说，对于元素 $x$，其对应的两个候选位置计算如下：
\begin{align}
  h_1(x) & = \mathsf{hash}(x) \\
  h_2(x) & = h_1(x) \oplus \mathsf{hash}(x\mbox{'s fingerprint}) \label{eq:cuckoo_h2}
\end{align}
式~\ref{eq:cuckoo_h2}中的异或操作正好满足了上述性质，即$h_1(x)$ 也可以通过 $h_2(x)$ 和 $x$ 的指纹信息计算得出。
另外，在异或操作中采用的是$x$指纹的哈希而不是$x$的指纹本身，这样做是因为如果只用指纹本身的话，两个候选位置之间的距离就受限于指纹的取值范围。
比如使用 $8$ 比特长度的指纹，那么两个候选位置之间最多相差 $256$。
而使用指纹的哈希则可以确保两个候选位置可以分布在过滤器中的任意位置，从而降低哈希碰撞的概率并提高存储空间的利用率。

通过上述讨论，我们可以直接给出布谷鸟过滤器的 $\mathsf{Construct}$ 算法思路。
以输入集合 $S$ 为例，对于每一个元素 $x\in S$，插入 $x$ 的过程描述如下：
\begin{itemize}
  \item 首先计算 $x$ 的指纹值 $f$，以及两个候选位置信息 $h_1(x)$ 和 $h_2(x)$。
  \item 只要 $h_1(x)$ 和 $h_2(x)$ 两个位置上有一个桶有空余，那么直接将 $f$ 插入空余的桶中，否则进入下一步。
  \item 随机从 $h_1(x)$ 和 $h_2(x)$ 中选取一个位置 $i$，并从该位置上踢出一个指纹，并将 $f$ 插入。踢出的指纹再计算出它的另一个候选位置，执行插入步骤。
\end{itemize}
在布谷鸟过滤器的构造过程中，会设置一个最大踢出值，当踢出的指纹超过最大值时将直接返回错误指示符 $\perp$。

布谷鸟过滤器的 $\mathsf{Evaluate}$ 算法比较直接，给定输入的元素 $x$，只需要计算它对应的两个位置 $h_1(x)$ 和 $h_2(x)$，如果在这两个位置上至少有一个桶中含有 $x$ 的指纹，那么返回 $\mathsf{True}$，否则返回 $\mathsf{False}$。

除了在\textbf{定义~\ref{def:filter}}中的 $\mathsf{Construct}$ 和 $\mathsf{Evaluate}$ 两个算法之外，布谷鸟过滤器中还支持删除操作。
这也是布谷鸟过滤器相比布隆过滤器的一大优势。
删除算法与 $\mathsf{Evaluate}$ 算法类似，也比较直接，即对需要删除的元素 $x$ 计算出 $h_1(x)$ 和 $h_2(x)$ 两个位置之后，如果这两个位置上有一个包含 $x$ 的指纹，则直接移除该位置上的指纹信息。
注意在删除过程中，如果找到两个位置上都存在 $x$ 的指纹时，只需要移除其中一个位置上的指纹信息即可。
这是因为当两个元素具有相同的指纹信息时，这样做就不会影响对另一个元素的存在性判断。
当然，只删除一个会带来假阳性的问题，但这对于大部分过滤器结构来说都是无法避免的，我们只需要将假阳性率控制在较小的值即可。

\subsection{布谷鸟过滤器的性能}

我们用 $|f|$ 表示指纹值的比特长度，当给定 $h_1(x)$ 的值时，也就确定了 $h_2(x)$ 有 $2^{|f|}$ 种不同取值。
假设布谷鸟过滤器中包含 $m$ 个桶，当 $2^{|f|} < m$ 时，$h_2(x)$ 的取值范围也就是整个过滤器长度的子集。
因此，当 $|f|$ 取值越小时，哈希碰撞的几率也会越大，构建过滤器的失败概率也会随之增大。
而且当 $m$ 与 $2^|f|$ 之间的差距越大时，布谷鸟过滤器的空间利用率也会越低。
% $m$ 与 $2^|f|$ 的差距越大时，哈希碰撞的几率
如何设定合适的参数就显得尤为重要。

% 假定有 $q$ 个元素对应相同位置的两个桶，其中第一个元素 $x$ 对应的第一个位置为 $h_1(x)$，其指纹信息为 $t_x$。
% 那么其他 $q-1$ 个元素必须满足：1）具有相同的指纹 $t_x$，即概率为 $1/2^{|f|}$；2）具有相同的位置 $h_1(x)$ 或 $h_1 \oplus h(t_x)$，即概率为 $2/m$。
% 因此 $q$ 个元素共享相同位置的概率为 $(2/m \cdot 1/2^{|f|})^{q-1}$。

我们用负载因子 $\alpha$ （$0\leq \alpha \geq 1$） 来表示布谷鸟过滤器的空间利用率，它的定义是过滤器中已占用空间大小与过滤器大小的比值。
因此当 $\alpha$ 的值越接近 $1$，那就表示空间利用率越高。
% 从文献~\cite{fan2014cuckoo}的实验结果来看，当
在给定指纹长度 $|f|$ 和负载因子 $\alpha$ 的情况下，对于每个元素均摊的空间开销 $C$ 可以表示为：
\begin{equation}
  C = \frac{\mbox{过滤器的存储大小}}{\mbox{存储的条目数}} = \frac{|f| \cdot \mbox{总条目数}}{\alpha \cdot \mbox{总条目数}} = \frac{|f|}{\alpha} \mbox{ bits}.
  \label{eq:cuckoo_C}
\end{equation}
负载因子的大小受到桶大小（用 $b$ 表示）的影响。
当 $b=1$ 时，负载因子仅有 $50\%$，而当 $b=4$ 或 $b=8$ 时，负载因子随之增长为 $95\%$ 和 $98\%$。
而当桶越大时，就越容易出现碰撞（即相同指纹信息）的情况。
为了保证相同的假阳性率，就要求指纹长度越长。
根据文献~\cite{fan2014cuckoo}中的推导，指纹长度 $|f|$ 与假阳性率 $\epsilon$ 和桶大小$b$ 之间的关系如下所示：
\begin{equation}
  |f| \geq \lceil\log_2(2b / \epsilon) \rceil = \lceil \log_2(1/\epsilon) + \log_2(2b) \rceil \mbox{ bits}.
  \label{eq:cuckoo_f}
\end{equation}
从式~\ref{eq:cuckoo_C}和式~\ref{eq:cuckoo_f}可以得出：
\begin{equation}
  C \leq \lceil \log_2(1/\epsilon) + \log_2(2b) \rceil / \alpha.
\end{equation}
当 $b=4$ 时，此时均摊空间开销约为 $(\log_2(1/\epsilon) + 3) / \alpha$，其中 $\alpha \approx 95\%$。
而对于布隆过滤器，其均摊空间开销约为 $1.44 \log_2(1/ \epsilon)$。
因此，相比于布隆过滤器，布谷鸟过滤器可以实现更优的均摊空间开销。
文献~\cite{fan2014cuckoo}中的实验结果表示，当 $b$ 取 $4$ 的时候，布谷鸟过滤器能在假阳性率和空间开销之间取得较好的平衡。

% 我们使用 $b$ 来表示桶的大小。
% 当哈希函数数量为 $2$，$b=1$ 时，负载因子 $\alpha$ 为 $50\%$。
% 但当我们增加 $b$ 的大小时，负载因子会随之增长。

\section{异或型过滤器}

Bloomier 过滤器~\cite{chazelle2004bloomier} 是首个异或型构造的过滤器。
尽管提出时间比较早，但直到近几年出现基于



\subsection{异或过滤器}


\subsection{二进制引信过滤器}


\section{不经意的键值存储}

\subsection{RB-OKVS}
